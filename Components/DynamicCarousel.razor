@inherits CarouselByScript

@{
    base.BuildRenderTree(__builder);
}

@code {

    [Parameter] public required Type ItemType { get; set; }
    [Parameter] public IDictionary<string, object>[]? ItemsParameters { get; set; }

    private DynamicComponent[] carouselItems;

    private int lastSlideIndex = -1;

    protected override void OnInitialized()
    {
        if (ItemsParameters == null || ItemsParameters.Count() == 0)
            return;

        totalNumberOfItems = ItemsParameters.Length;

        carouselItems = new DynamicComponent[totalNumberOfItems];
        Items = new RenderFragment[totalNumberOfItems];
        for (int i = 0; i < totalNumberOfItems; i++)
            Items[i] = CreateItem(i);

        base.OnInitialized();
    }

    // protected override void OnAfterRender(bool firstRender)
    // {
    //     base.OnAfterRender(firstRender);
    //     if (firstRender)
    //         PlayCurrentSlide();
    // }

    private RenderFragment CreateItem(int index)
    {
        if (ItemsParameters == null)
            return @<></>;
        return@<DynamicComponent Type="ItemType" Parameters="ItemsParameters[index]" @ref="carouselItems[index]"></DynamicComponent>;
    }

    protected override Task ScrollTo(int position)
    {
        lastSlideIndex = currentSlide;
        return base.ScrollTo(position);
    }

    protected override void OnFinishedScrolling()
    {
        base.OnFinishedScrolling();
        PlayCurrentSlide();
    }

    private void PlayCurrentSlide()
    {
        if (carouselItems == null || carouselItems.Length == 0 || carouselItems.Length <= currentSlide)
            return;

        (carouselItems[currentSlide].Instance as ICarouselComponent)?.StartRendering();

        if (lastSlideIndex != currentSlide && lastSlideIndex >= 0)
        {
            (carouselItems[lastSlideIndex].Instance as ICarouselComponent)?.StopRendering();
            lastSlideIndex = -1;
        }
    }

    // protected override void OnItemFocused(int id)
    // {
    //     base.OnItemFocused(id);
    //     PlayCurrentSlide();
    //     if (lastSlideIndex != currentSlide && lastSlideIndex >= 0)
    //         (carouselItems[lastSlideIndex].Instance as ICarouselComponent)?.StopRendering();
    // }
}
